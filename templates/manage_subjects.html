<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Subjects</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-screen">
    {% include '_header.html' %}
    
    <main class="container mx-auto px-4 py-8 max-w-3xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-green-600 mb-2">
                Subject Management
            </h1>
            <p class="text-gray-600">Configure subjects for each class</p>
        </div>

        <!-- Centered Class Selection -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <label class="block text-lg font-medium text-gray-700 mb-4 text-center">Select Class</label>
            <select id="classSelect" 
                    class="w-full max-w-md mx-auto block px-4 py-3 rounded-lg border-2 border-gray-200 
                           focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all">
                <option value="">Choose a class...</option>
                {% for cls in classes %}
                    <option value="{{ cls }}">Class {{ cls }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Subject Management Section -->
        <div id="subjectSection" class="hidden bg-white rounded-xl shadow-lg p-6">
            <div id="loadingState" class="text-center py-8 hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <p class="text-gray-600">Loading subjects...</p>
            </div>

            <form id="subjectForm" method="POST" class="space-y-6">
                <input type="hidden" name="class_name" id="selectedClass">
                
                <div id="subjectList" class="space-y-4">
                    <!-- Subjects will be added here -->
                </div>

                <div class="flex justify-center mt-6">
                    <button type="button" id="addSubject" 
                            class="inline-flex items-center px-4 py-2 border-2 border-blue-500 text-blue-500 
                                   rounded-lg hover:bg-blue-50 transition-all">
                        <span class="text-xl mr-2">+</span>
                        Add Subject
                    </button>
                </div>

                <div class="flex justify-center mt-8">
                    <button type="submit" 
                            class="bg-green-500 text-white px-8 py-3 rounded-lg hover:bg-green-600
                                   transition-all flex items-center">
                        <span class="text-xl mr-2">ðŸ’¾</span>
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const classSelect = document.getElementById('classSelect');
            const subjectSection = document.getElementById('subjectSection');
            const subjectList = document.getElementById('subjectList');
            const addSubjectBtn = document.getElementById('addSubject');
            const selectedClassInput = document.getElementById('selectedClass');
            const loadingState = document.getElementById('loadingState');

            async function loadSubjects(className) {
                // Show loading state
                loadingState.classList.remove('hidden');
                subjectList.classList.add('hidden');
                subjectSection.classList.remove('hidden');

                try {
                    const response = await fetch(`/api/subjects/${className}`);
                    if (!response.ok) throw new Error('Failed to fetch subjects');
                    
                    const subjects = await response.json();
                    
                    if ('error' in subjects) {
                        throw new Error(subjects.error);
                    }

                    subjectList.innerHTML = '';
                    
                    if (subjects.length === 0) {
                        subjectList.innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                <p>No subjects configured for Class ${className}</p>
                            </div>
                        `;
                    } else {
                        subjects.forEach(subject => {
                            subjectList.appendChild(createSubjectEntry(subject));
                        });
                    }
                } catch (error) {
                    console.error('Error loading subjects:', error);
                    subjectList.innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <p>Error loading subjects: ${error.message}</p>
                            <button onclick="retryLoad('${className}')" 
                                    class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg">
                                Retry
                            </button>
                        </div>
                    `;
                } finally {
                    loadingState.classList.add('hidden');
                    subjectList.classList.remove('hidden');
                }
            }

            function retryLoad(className) {
                loadSubjects(className);
            }

            function removeSubject(button) {
                const subjectEntry = button.closest('.bg-gray-50');
                if (subjectEntry) {
                    subjectEntry.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => {
                        subjectEntry.remove();
                    }, 200);
                }
            }

            // Make removeSubject available globally
            window.removeSubject = removeSubject;

            function createSubjectEntry(subject = { name: '', max_marks: 100 }) {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-4 rounded-lg border-2 border-gray-200 hover:border-blue-300 transition-all duration-200';
                div.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-center">
                        <div class="md:col-span-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Subject Name</label>
                            <input type="text" name="subject_names[]" 
                                   value="${subject.name}"
                                   class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 
                                          focus:border-blue-500 focus:ring focus:ring-blue-200" 
                                   placeholder="Enter subject name" required>
                        </div>
                        <div class="md:col-span-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Maximum Marks</label>
                            <input type="number" name="max_marks[]" 
                                   value="${subject.max_marks}"
                                   class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 
                                          focus:border-blue-500 focus:ring focus:ring-blue-200" 
                                   min="0" step="1" required>
                        </div>
                        <div class="md:col-span-2 flex justify-center md:justify-end">
                            <button type="button" 
                                    onclick="removeSubject(this)"
                                    class="text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-50
                                           transition-all">
                                <span class="text-xl">Ã—</span>
                            </button>
                        </div>
                    </div>
                `;
                return div;
            }

            classSelect.addEventListener('change', () => {
                const selectedClass = classSelect.value;
                if (!selectedClass) {
                    subjectSection.classList.add('hidden');
                    return;
                }

                selectedClassInput.value = selectedClass;
                subjectSection.classList.remove('hidden');
                loadSubjects(selectedClass);
            });

            addSubjectBtn.addEventListener('click', () => {
                subjectList.appendChild(createSubjectEntry());
            });
        });
    </script>
</body>
</html>
